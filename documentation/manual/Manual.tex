% ==============================================================================
% Copyright Government of Canada 2015-2016
%
% Written by: Eric Marinier, Public Health Agency of Canada,
%     National Microbiology Laboratory
%
% Funded by the National Micriobiology Laboratory and the Genome Canada / Alberta
%     Innovates Bio Solutions project "Listeria Detection and Surveillance
%     using Next Generation Genomics"
%
% Licensed under the Apache License, Version 2.0 (the "License"); you may not use
% this file except in compliance with the License. You may obtain a copy of the
% License at:
%
% http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software distributed
% under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
% CONDITIONS OF ANY KIND, either express or implied. See the License for the
% specific language governing permissions and limitations under the License.
% ==============================================================================

\documentclass[a4paper,10pt]{article}

\usepackage[utf8]{inputenc}
\usepackage{amssymb,amsmath}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{courier}
\usepackage[margin=1in]{geometry}
\usepackage[procnames]{listings} % Code Blocks
\usepackage{soul} % Underline

\lstset{
  frame=tb,
  basicstyle={\small\ttfamily},
  language=bash,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  numbers=none,
  %numberstyle=\tiny\color{gray},
  keywordstyle=\color{black},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  postbreak=\raisebox{0ex}[0ex][0ex]{\ensuremath{\color{red}\hookrightarrow\space}}
  %breakatwhitespace=true,
  %tabsize=3
}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\hypersetup{
    colorlinks,
    linkcolor={black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
}

\setlength\parindent{0pt}
\setlength{\parskip}{0.5em}

%opening
\title{Neptune\\ \normalsize Version 1.2.4}
\author{Eric Marinier}


\begin{document}

%Code Block Style Definitions
\definecolor{keywords}{RGB}{76,154,98}
\definecolor{comments}{RGB}{87,134,146}
\definecolor{functions}{RGB}{19,52,131}
\definecolor{red}{RGB}{160,0,0}
\definecolor{green}{RGB}{0,150,0}
\definecolor{background}{RGB}{248, 249, 250}
\definecolor{border}{RGB}{224, 226, 230}

\lstdefinestyle{bash}{language=bash, 
        keywordstyle=\color{black},
        commentstyle=\color{comments},
        stringstyle=\color{red},
        showstringspaces=false,
        identifierstyle=\color{black},
        rulecolor=\color{border},
        backgroundcolor=\color{background}}


\maketitle

\newpage
\tableofcontents

\newpage
\section{Introduction}

Neptune locates genomic signatures using an exact \textit{k}-mer matching strategy while accommodating \textit{k}-mer mismatches. The software identifies sequences that are sufficiently represented within inclusion targets and sufficiently absent from exclusion targets. The signature discovery process is guided by probabilistic models instead of heuristic strategies. Neptune identifies general-purpose signatures are agnostic of application-specific requirements, such as physical and chemical properties, and may require further investigation to determine their appropriateness for application.

\newpage
\section{Installation}

This installation guide assumes the use of the \href{https://en.wikipedia.org/wiki/Bash_(Unix_shell)}{BASH} Unix shell. Neptune may be installed on most 64-bit Unix environments. However, the specifics of installations on all environments is beyond the scope of this manual. Neptune may either be run on a single machine or a computing cluster. Neptune achieves maximum parallelization when submitting jobs through a DRMAA-compliant cluster computing scheduler. The installation and configuration of a DRMAA-compliant scheduler will require a significant understanding of Unix. However, it is possible to run Neptune in parallel on a single machine without DRMAA. Neptune is known to be compatible with the \href{http://gridscheduler.sourceforge.net/}{SGE} and \href{http://slurm.schedmd.com/}{Slurm} schedulers.

\subsection{Python}

Neptune requires Python 2.7. Note that Python 2.7 is provided with many major distributions of Linux. The following may check your Python version:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
$ python --version
\end{lstlisting}
\end{minipage}

\subsection{Dependencies}

\subsubsection{Debian-Based Installation}

This section assumes the user has the \href{https://help.ubuntu.com/community/AptGet/Howto}{APT} package manager. This is common to the \href{https://en.wikipedia.org/wiki/Ubuntu_(operating_system)}{Ubuntu} operating system. However, this section should be compatible with any 64-bit Debian distribution. The following operation will automatically install Neptune's dependencies and require security privileges (sudo) to install the dependencies:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
$ sudo neptune/install/debian_dependencies.sh
\end{lstlisting}
\end{minipage}

\subsubsection{Manual Installation}

If you cannot install the dependencies using the above script, the following dependencies must be manually installed, if necessary, by the user:

\begin{itemize}
  \small
  \item pip
  \item virtualenv
  \item build-essential
  \item python-dev
  \item NCBI BLAST+
\end{itemize}

\subsection{Neptune}

Neptune will be installed using pip into its own Python virtual environment. The following will install Neptune locally into the source directory and will not require security privileges:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
$ neptune/INSTALL.sh
\end{lstlisting}
\end{minipage}

Alternatively, you may specify an install location, PREFIX, such as /usr/local/. Neptune will create the directories PREFIX/lib and PREFIX/bin. This may require security privileges:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
$ neptune/INSTALL.sh PREFIX
\end{lstlisting}
\end{minipage}

\newpage
\subsection{DRMAA Requirements}

The following is only necessary for execution of Neptune in DRMAA mode on a cluster computing environment. These instructions require a strong understanding of Unix and cluster computing configuration. The user will need to manually install and configure a DRMAA-compliant scheduler, such as \href{http://gridscheduler.sourceforge.net/}{SGE} or \href{http://slurm.schedmd.com/}{Slurm}, on either a single machine or on a computing cluster. The user will additionally need to install and configure Python DRMAA bindings with considerations for the DRMAA-compliant scheduler. The following are required to operate Neptune in DRMAA mode:

\begin{enumerate}
  \item DRMAA-compliant scheduler
  \item Python DRMAA bindings
\end{enumerate}

\subsubsection{DRMAA-Compliant Scheduler}

Neptune has been tested using SGE installed on a single machine with the following instructions:
\newline\newline
\url{https://scidom.wordpress.com/2012/01/18/sge-on-single-pc/}
\newline\newline
However, any DRMAA-compliant scheduler is expected to work. The instructions for installing and configuring such scheduling environments are beyond the scope of this resource.

\subsubsection{Python DRMAA Bindings}

Neptune uses a Python DRMAA binding to schedule parallel jobs and communicate with the scheduler. The information necessary for installing and configuring the Python DRMAA bindings is available the following location:
\newline\newline
\url{https://github.com/pygridtools/drmaa-python}

\subsection{DRMAA Installation}

It may be helpful to create a submission wrapper script for Neptune to avoid entering the same DRMAA native specification parameters for every submission. The following SGE and Slurm submission wrapper scripts automatically include native specification parameters, appropriate for the scheduling environment, which may be overwritten by the submitting user as necessary.

\subsubsection{Slurm Wrapper}

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash, title={neptune-slurm}]
#!/usr/bin/env bash

DRMAA_LIBRARY_PATH=/usr/local/lib/libdrmaa.so.1

neptune --drmaa --default-specification "-n 1 --nodes=1 --ntasks-per-node=1 --mem=10240" $@
\end{lstlisting}
\end{minipage}

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash, title={Slurm Example}]
$ neptune-slurm -i /path/to/inclusion/ -e /path/to/exclusion/ -o /path/to/output/
\end{lstlisting}
\end{minipage}

\subsubsection{SGE Wrapper}

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash, title={neptune-sge}]
#!/usr/bin/env bash

DRMAA_LIBRARY_PATH=/opt/gridengine/lib/linux-x64/libdrmaa.so

neptune --drmaa --default-specification "-l h_vmem=8G -pe smp 4" $@
\end{lstlisting}
\end{minipage}

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash, title={SGE Example}]
$ neptune-sge -i /path/to/inclusion/ -e /path/to/exclusion/ -o /path/to/output/
\end{lstlisting}
\end{minipage}

\newpage
\section{Parameters}

A help message may be viewed by running:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
$ neptune --help
\end{lstlisting}
\end{minipage}

\subsection{Required Parameters}

Neptune requires the location of the inclusion, exclusion, and output directories. The remaining parameters will be estimated based on the input sequence or revert to default settings. The following is the minimum number of command line parameters required to run Neptune:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
$ neptune --inclusion /path/to/inclusion/ --exclusion /path/to/exclusion/ --output /path/to/output/
\end{lstlisting}
\end{minipage}

The following parameters are required by Neptune:

\begin{description}

  \item[inclusion] \hfill \\
  \textbf{-i [LOCATION] [LOCATION ...] // -{}-inclusion [LOCATION] [LOCATION ...]} \hfill \\
  A list of inclusion targets in FASTA format. You may list multiple file or directory locations following the \textbf{-{}-inclusion} parameter. Neptune will automatically include all root-level files within directories.  
  
  \item[exclusion] \hfill \\
  \textbf{-e [LOCATION] [LOCATION ...] // -{}-exclusion [LOCATION] [LOCATION ...]} \hfill \\
  A list of exclusion targets in FASTA format. You may list multiple file or directory locations following the \textbf{-{}-exclusion} parameter. Neptune will automatically include all root-level files within directories.
  
  \item[output] \hfill \\
  \textbf{-o [LOCATION] // -{}-output [LOCATION]} \hfill \\
  The location of the output directory. If this directory exists, any files produced with existing names will be overwritten. If this directory does not exist, then it will be created.
  
\end{description}

\subsection{\textit{k}-mer Parameters}

The following parameters relate to \textit{k}-mer generation and aggregation:

\begin{description}

  \item[\textit{k}-mer] \hfill \\
  \textbf{-k [INT] // -{}-kmer [INT]} \hfill \\
  The size of the \textit{k}-mers. This must be a positive integer and should be large enough such that random \textit{intra}-genome \textit{k}-mer matches, within the largest genome, are unexpected. The size of \textit{k}-mers cannot be larger than the smallest sequence record.
  
  \item[organization] \hfill \\
  \textbf{-{}-organization [INT]} \hfill \\
  The degree of organization of \textit{k}-mer counting and aggregation. This parameter determines the number nucleotide bases used in parallelized \textit{k}-mer counting and, in turn, the number of parallel instances of \textit{k}-mer aggregation. The number of parallel instances is determined by \(4^{o}\), where \(o\) is the specified organization argument (\textbf{\mbox{-{}-organization}}). This value must be a non-negative integer smaller than \textit{k}. If the parameter is not specified, then \(o = 0\) and there will be no parallel \textit{k}-mer aggregation. This will likely require a much longer computation time to complete \textit{k}-mer aggregation.
  
\end{description}

\subsection{Filtering Parameters}

The following command-line parameters relate to signature filtering:

\begin{description}

  \item[filter length] \hfill \\
  \textbf{-{}-filter-length [FLOAT]} \hfill \\
  The minimum percent length of a signature candidate against a exclusion target required to filter out the candidate. This value is a percentage expressed as a floating point number [0.0, 1.0]. If the any exclusion hit exceeds the percent length \textbf{and} percent identity of any candidate, the candidate is removed. The default value is 0.5.
  
  \item[filter percent] \hfill \\
  \textbf{-{}-filter-percent [FLOAT]} \hfill \\
  The minimum percent identity of a signature candidate against a exclusion target required to filter out the candidate. The percent identity is calculated as identities divided by the alignment length. This value is a percentage expressed as a floating point number [0.0, 1.0]. If the any exclusion hit exceeds the percent length \textbf{and} percent identity of any candidate, the candidate is removed. The default value is 0.5.
  
  \item[seed size] \hfill \\
  \textbf{-{}-seed-size [INT]} \hfill \\
  The seed size used for alignments. This value must be no smaller than 4. The default value is 11.
  
\end{description}
  
\subsection{Extraction Parameters}

The following command-line parameters relate to signature extraction:

\begin{description}

  \item[reference] \hfill \\
  \textbf{-r [FILE] [FILE ...] // -{}-reference [FILE] [FILE ...]} \hfill \\
  A list of references from which to extract signatures. If this parameter is not specified, signatures will be extracted from \textbf{all} inclusion targets. You may list multiple file locations following the \textbf{-{}-reference} parameter.
  
  \item[rate] \hfill \\
  \textbf{-{}-rate [FLOAT]} \hfill \\
  This is the probability (0.0, 1.0) that any two homologous bases are different from each other. This should incorporate mutation rates, sequencing error rates, and assembly error rates. The rate is used to calculate the maximum allowable gap size in a signature and the minimum expected number of exact \textit{k}-mer matches in a signature. If this value is not specified, the rate is assumed to be 0.01.
  
  \item[gc-content] \hfill \\
  \textbf{-{}-gc-content [FLOAT]} \hfill \\
  The expected GC-content of the environment. The GC-content is used to calculate the maximum allowable gap size in a signature and the minimum expected number of exact \textit{k}-mer matches in a signature. If this value is not specified, it is calculated by observing the GC-content of each target during signature extraction. The value must be between (0.0, 1.0).
  
  \item[confidence] \hfill \\
  \textbf{-{}-confidence [FLOAT]} \hfill \\
  The statistical confidence of decision making in the software. The confidence affects the automatic calculation of both the maximum gap size and minimum number of inclusion hits. If this value is not specified, a default of 0.95 is used. The value must be between (0.0, 1.0).
  
  \item[minimum inclusion hits] \hfill \\
  \textbf{-{}-inhits [INT]} \hfill \\
  The minimum number of inclusion hits required to start and continue signature extraction. If this value is not specified, it will be automatically calculated using the number of inclusion targets, the GC-content, the rate, and the \textit{k}-mer size. The calculation can be found in the \textit{Mathematics} documentation. This value must be a positive integer.
  
  \item[minimum exclusion hits] \hfill \\
  \textbf{-{}-exhits [INT]} \hfill \\
  The minimum number of exclusion hits necessary to stop extraction of a signature. If this value is not specified, it is assumed to be 1. This value must be a positive integer.
  
  \item[maximum gap size] \hfill \\
  \textbf{-{}-gap [INT]} \hfill \\
  The maximum allowable number of base positions shifted before seeing an exact \textit{k}-mer match. If this value is not specified, it will be automatically calculated using the rate, GC-content, and the k-mer size. The calculation can be found in the \textit{Mathematics} documentation. This value must be a positive integer.
  
  \item[minimum signature size] \hfill \\
  \textbf{-{}-size [INT]} \hfill \\
  The minimum size for a signature. Signatures which are shorter than this length will not be reported. If this value is not specified, the minimum signature size will be four times the length of the \textit{k}-mer size (\(4k\)). It is not recommended to locate signatures smaller than this size, unless application-specific. This value must be a positive integer.

\end{description}
  
\subsection{Parallelization Parameters}

The following parameters relate to the parallelization of Neptune:

\begin{description}

  \item[parallelization] \hfill \\
  \textbf{-p [INT] // -{}-parallelization [INT]} \hfill \\
  The number of parallel working processes to create when Neptune is operating in a non-DRMAA mode (default). This parameter will directly increase the speed of many stages of the software, provided there are sufficient resources available to run the worker process simultaneously. This value must be a positive integer. The default value is 8.

\end{description}
  
\subsection{DRMAA Parameters}

It may be necessary to specify job submission parameters that are required by your cluster-computing environment. If you require DRM-specific command line arguments, they may be provided to Neptune using one of several arguments. The \mbox{\textbf{-{}-default-specification}} parameter will provide the DRM-specific arguments to all jobs which are created. Additional command line arguments allow precise specifications for each type of job.

\begin{description}

  \item[drmaa] \hfill \\
  \textbf{-{}-drmaa} \hfill \\
  This flag enables DRMAA-based Neptune execution. This will require a DRMAA-compatible cluster computing environment to be installed and configured. However, Neptune will likely operate significantly faster in this environment.

  \item[default specification] \hfill \\
  \textbf{-{}-default-specification [STRING]} \hfill \\
  DRMAA-specific command line arguments for all jobs. These arguments must be provided as a quoted string. The default specification will be applied to all job types and overwritten when specified.
  
  \item[count specification] \hfill \\
  \textbf{-{}-count-specification [STRING]} \hfill \\
  DRMAA-specific command line arguments for \textit{k}-mer counting. These arguments must be provided as a quoted string. These arguments will overwrite the default specification, if specified, for this job type.
  
  \item[aggregate specification] \hfill \\
  \textbf{-{}-aggregate-specification [STRING]} \hfill \\
  DRMAA-specific command line arguments for \textit{k}-mer aggregation. These arguments must be provided as a quoted string. These arguments will overwrite the default specification, if specified, for this job type.
  
  \item[extract specification] \hfill \\
  \textbf{-{}-extract-specification [STRING]} \hfill \\
  DRMAA-specific command line arguments for signature extraction. These arguments must be provided as a quoted string. These arguments will overwrite the default specification, if specified, for this job type.
  
  \item[database specification] \hfill \\
  \textbf{-{}-database-specification [STRING]} \hfill \\
  DRMAA-specific command line arguments for database construction. These arguments must be provided as a quoted string. These arguments will overwrite the default specification, if specified, for this job type.
  
  \item[filter specification] \hfill \\
  \textbf{-{}-filter-specification [STRING]} \hfill \\
  DRMAA-specific command line arguments for candidate signature filtering. These arguments must be provided as a quoted string. These arguments will overwrite the default specification, if specified, for this job type.
  
  \item[consolidate specification] \hfill \\
  \textbf{-{}-consolidate-specification [STRING]} \hfill \\
  DRMAA-specific command line arguments for signature consolidation. These arguments must be provided as a quoted string. These arguments will overwrite the default specification, if specified, for this job type.
  
\end{description}

\newpage
\section{Examples}

\subsection{Basic}

The following basic example will report all of the signatures that are sufficiently shared by the (FASTA) sequences in the inclusion directory and sufficiently absent from the (FASTA) sequences in the exclusion directory. Neptune will automatically calculate many of the parameters used in this execution.

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
$ neptune
    --inclusion inclusion_directory/
    --exclusion exclusion_directory/
    --output output_directory/ 
\end{lstlisting}
\end{minipage}

The output of immediate interest will be located in the follow file:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
output_directory/consolidated/consolidated.fasta
\end{lstlisting}
\end{minipage}

This file will contain a consolidated list of signatures, sorted by their Neptune score, which is a combined estimate of sensitivity and specificity. The signatures with higher scores, near the top of the file, are considered the most discriminatory signatures.

\subsection{File Locations}

You may wish to specify particular files used in signature discovery. This may be important when specifying references for signature extraction:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
$ neptune
    --inclusion inclusion_dir/ in1.fasta in2.fasta
    --exclusion exclusion_dir/ ex1.fasta ex2.fasta
    --reference in1.fasta in2.fasta    
    --output output/
\end{lstlisting}
\end{minipage}

\subsection{DRMAA Parameters}

It may be necessary to specify DRMAA native specification parameters to accommodate Neptune job scheduling. This example specifies the resources required by all jobs (\mbox{\textbf{-{}-default-specification}}) and further specifies that \textit{k}-mer aggregation jobs (\mbox{\textbf{-{}-aggregate-specification}}) will require more memory. The remaining Neptune parameters are automatically calculated.

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
$ neptune
    --inclusion inclusion/
    --exclusion exclusion/
    --output output/
    --default-specification "-l h_vmem=6G -pe smp 4"
    --aggregate-specification "-l h_vmem=10G -pe smp 4"
\end{lstlisting}
\end{minipage}


\newpage
\section{Output}
\label{section:output}

Neptune's output directory contains the following items:

\begin{itemize}
  \item \textbf{candidates}: directory containing signature candidates
  \item \textbf{filtered}: directory containing filtered candidates in extracted order
  \item \textbf{sorted}: directory containing filtered signatures in sorted order
  \item \textbf{consolidated}: directory containing the consolidate signatures
  \item \textbf{database}: directory containing Neptune's constructed databases
  \item \textbf{aggregate.kmers}: file containing all observed \textit{k}-mers
  \item \textbf{receipt.txt}: file containing Neptune's run receipt
\end{itemize}

A file with the same name as each reference will be placed in each output directory, corresponding to the reference file from which it was derived.

\subsection{Candidate Signatures}

The candidate signatures are the sequences produced from the signature extraction step. These signatures will relatively sensitive, but not necessarily specific. This is because signature extraction is done using exact \textit{k}-mer matches. The candidate signatures are guaranteed to contain no more exact matches with any exclusion \textit{k}-mer than specified by the \mbox{\textbf{-{}-exhits}} parameter. However, there may be inexact matches with exclusion targets.

\subsection{Filtered Signatures}

The filtering step is designed to remove signatures which are not interesting enough to warrant further investigation, because the negative component of their score is prohibitively large. The filtering step removes signatures that align sufficiently with any exclusion target. The filtered signatures are a subset of the candidate signatures.

\subsection{Sorted Signatures}

The sorted signatures files are organized as FASTA records containing the same signatures as their filtered signatures counterparts. However, the signatures are listed in descending order by their signature score. Signatures are assigned a score corresponding to their highest-scoring BLAST alignments with all inclusion and exclusion targets, which is a sum of a positive inclusion component and a negative exclusion component. This score is maximized when all inclusion targets contain a region exactly matching the entire signature and there exists no exclusion targets that match the signature. The signatures have the following format:

\begin{verbatim}
>[ID] [SCORE] [IN SCORE] [EX SCORE] [LENGTH] [REF] [POS]
[SEQUENCE]
\end{verbatim}

\begin{verbatim}
>425 score=0.86 in=0.98 ex=-0.13 len=31 ref=ecoli pos=160
TGTCATTCTCCTGTTCTGCCTGTATCACTGC
\end{verbatim}

Where:

\begin{itemize}
  \item \textbf{[ID]}: an \ul{arbitrary}, run-unique ID assigned to the signature
  \item \textbf{[SCORE]}: the total signature score
  \item \textbf{[IN SCORE]}: positive inclusion component of signature score
  \item \textbf{[EX SCORE]}: negative exclusion component of signature score
  \item \textbf{[LENGTH]}: signature length in bases
  \item \textbf{[REF]}: name of the contig from which the signature was extracted
  \item \textbf{[POS]}: starting position of the signature in the reference
  \item \textbf{[SEQUENCE]}: sequence content of the signature
\end{itemize}

\subsection{Consolidated Signatures}

The sorted signatures from all references are combined into a single ``consolidated.fasta'' file, located within the ``consolidated'' directory. Signatures are added to the consolidated signatures file in a greedy manner by selecting the next highest scoring signature available from all references. While effort is taken to prevent signatures from overlapping entirely, it is possible for consolidate signatures to have a small amount of overlap.

\subsection{Databases}

The databases directory contains BLAST databases constructed from the inclusion and exclusion files.

\subsection{Aggregate k-mers}

The aggregated \textit{k}-mers file, aggregated.kmers, contains a list of all \textit{k}-mers observed in the inclusion and exclusion groups. These \textit{k}-mers are sorted and followed by two integers: the number of inclusion and exclusion targets the \textit{k}-mer appears in, respectively.

\subsection{Run Receipt}

The run receipt contains information about the Neptune execution. It contains a list of all the files in the inclusion and exclusion group, and the command line parameters used for the execution.

\newpage
\section{Walkthrough}

\subsection{Overview}

The purpose of this walkthrough will be to illustrate a simple, but complete example of using Neptune. We will identity signatures within an artificial data set containing three inclusion sequences and three exclusion sequences. The output will be a list of signatures, sorted by score, for each inclusion target, and one consolidated signatures file, sorted by signature score, containing signatures from all inclusion targets.

\subsection{Input Data}

We will be using very small, artificial genomes for this walkthrough. However, it will be sufficient to illustrate the operation of Neptune. The sequence content is derived from \textit{Escherichia coli} and has been modified to introduce simple variation between genomes.

The inclusion genomes are located in the following location:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
neptune/tests/data/example/inclusion/
\end{lstlisting}
\end{minipage}

The exclusion genomes are located in the following location:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
neptune/tests/data/example/exclusion/
\end{lstlisting}
\end{minipage}

The inclusion and exclusion directories each contain three FASTA-format genomes. The genomes all have some insertions and deletions that differentiate them from each other. However, the three inclusion genomes differ from the three exclusion genomes in that they share large sequences that are absent from all exclusion genomes.

\subsection{Running Neptune}

Neptune will automatically calculate many of the parameters that can be specified, such as the minimum number of targets signature sequence must be present within for it to be considered shared sequence. At minimum, Neptune requires inclusion sequences, exclusion sequences, and an output directory. We will provide Neptune inclusion and exclusion sequences in the form of FASTA genomes located within directories. The following command will run Neptune on the example data:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
$ neptune
    --inclusion tests/data/example/inclusion/
    --exclusion tests/data/example/exclusion/
    --output output/
\end{lstlisting}
\end{minipage}

\subsection{Output}

\subsubsection{Standard Output}

After running Neptune, the following output will be printed to standard output:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
Neptune v1.2.4

Estimating k-mer size ...
k = 15

k-mer Counting...
Submitted 12 jobs.
0.002063 seconds

k-mer Aggregation...
Submitted 65 jobs.
0.010473 seconds

Signature Extraction...
Submitted 6 jobs.
0.000771 seconds

Signature Filtering...
Submitted 2 jobs.
Submitted 6 jobs.
0.002498 seconds

Consolidate Signatures...
Submitted 1 jobs.
0.000411 seconds

Complete!
\end{lstlisting}
\end{minipage}

\subsubsection{Signatures}

As we did not specify references from which to extract signatures, Neptune automatically investigated all inclusion genomes for signatures and consolidated those signatures into a single file. The \textit{output/consolidated/consolidated.fasta} file contains these consolidated signatures. \ul{This file may be understood as the final output of the application}. The following FASTA output is from the consolidated signatures file produced from this example:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash, title=output/consolidated/consolidated.fasta]
>1.0 score=1.0000 in=1.0000 ex=0.0000 len=103 ref=inclusion1 pos=99
TAGTCTCCAGGATTCCCGGGGCGGTTCAGATAATCTTAGCATTGACCGCCTTTATATAGAAGCTGTTATTCAAGAAGCAT...
>1.1 score=0.9979 in=0.9979 ex=0.0000 len=640 ref=inclusion1 pos=3497
CGCGGGCGATATTTTCACAGCCATTTCAGGAGTTCAGCCATGAACGCTTATTACATTCAGGATCGTCTTGAGGCTCAGAG...
>1.2 score=0.9966 in=0.9966 ex=0.0000 len=98 ref=inclusion1 pos=5209
GCGAGTTTTGCGAGATGGTGCCGGAGTTCATCGAAAAAATGGACGAGGCACTGCTGAAATTGGTTTTGTATTTGGGGAGC...
\end{lstlisting}
\end{minipage}

The FASTA header contains information relavent to the identified signature. A detailed explanation of this information is located within the \hyperref[section:output]{output section}. The \textit{score} is the sum of the \textit{in} (inclusion/sensitivity) and \textit{ex} (exclusion/specificity) scores, and represents a combined measure of sensitivity and specificity. The \textit{length} describes the length of the signature in bases. The \textit{ref} (reference) and \textit{pos} (position) describe the location of the signature within the reference it was extracted from.

In this example, Neptune identified three signatures: 1.0, 1.1, and 1.2 of lengths 103, 640, and 98, respectively. We see that all of these signatures originated from the \textit{inclusion1} reference. These signatures were located at positions 99, 3497, and 5209 within the \textit{inclusion1} reference. These signatures are of very high quality, within the context of our data set, with scores of 1.0000, 0.9979, and 0.9969. Neptune signature scores have a possible range of values from -1.00 to +1.00.

If we're interested in looking at the signatures produced from each individual inclusion target, we need to investigate the output in the output/sorted directory. The following are the signatures extracted exclusively from the \textit{inclusion1.fasta} target:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash, title=output/sorted/inclusion1.fasta]
>0 score=1.0000 in=1.0000 ex=0.0000 len=103 ref=inclusion1 pos=99
TAGTCTCCAGGATTCCCGGGGCGGTTCAGATAATCTTAGCATTGACCGCCTTTATATAGAAGCTGTTATTCAAGAAGCAT...
>1 score=0.9979 in=0.9979 ex=0.0000 len=640 ref=inclusion1 pos=3497
CGCGGGCGATATTTTCACAGCCATTTCAGGAGTTCAGCCATGAACGCTTATTACATTCAGGATCGTCTTGAGGCTCAGAG...
>2 score=0.9966 in=0.9966 ex=0.0000 len=98 ref=inclusion1 pos=5209
GCGAGTTTTGCGAGATGGTGCCGGAGTTCATCGAAAAAATGGACGAGGCACTGCTGAAATTGGTTTTGTATTTGGGGAGC...
\end{lstlisting}
\end{minipage}

The following are the signatures extracted exclusively from the \textit{inclusion2.fasta} target:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash, title=output/sorted/inclusion2.fasta]
>0 score=1.0000 in=1.0000 ex=0.0000 len=103 ref=inclusion2 pos=99
TAGTCTCCAGGATTCCCGGGGCGGTTCAGATAATCTTAGCATTGACCGCCTTTATATAGAAGCTGTTATTCAAGAAGCAT...
>1 score=0.9979 in=0.9979 ex=0.0000 len=640 ref=inclusion2 pos=3494
CGCGGGCGATATTTTCACAGCCATTTTCAGGAGTTCAGCCATGAACGCTTATTACATTCAGGATCGTCTTGAGGCTCAGA...
>2 score=0.9933 in=0.9933 ex=0.0000 len=99 ref=inclusion2 pos=5206
GCGAGTTTTGACGAGATGGTGCCGGAGTTCATCGAAAAAATGGACGAGGCACTGCTGAAATTGGTTTTGTATTTGGGGAG...
\end{lstlisting}
\end{minipage}

The following are the signatures extracted exclusively from the \textit{inclusion3.fasta} target:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash, title=output/sorted/inclusion3.fasta]
>0 score=1.0000 in=1.0000 ex=0.0000 len=103 ref=inclusion3 pos=99
TAGTCTCCAGGATTCCCGGGGCGGTTCAGATAATCTTAGCATTGACCGCCTTTATATAGAAGCTGTTATTCAAGAAGCAT...
>2 score=0.9833 in=0.9833 ex=0.0000 len=100 ref=inclusion3 pos=5203
GCGAGTTTTAACGAGATGGTGCCGGAGTTCATCGAAAAAATGGACCGAGGCACTGCTGAAATTGGTTTTGTATTTGGGGA...
>1 score=0.9792 in=0.9979 ex=0.0187 len=640 ref=inclusion3 pos=3492
CGCGGGCGATATTTTCACAGCCATTTTCAGGAGTTCAGCCATGAACGCTTATTACATTCAGGATCGTCTTGAGGCTCAGA...
\end{lstlisting}
\end{minipage}

The output from these files appears very similar, as is expected when Neptune identifies highly discriminatory signatures. However, there are some slight differences between some of these signatures. For example, the signatures in each output file have corresponding ID numbers and some of these signatures have slight differences. However, because these IDs are effectively arbitrary, this correspondence will usually never happen when using real data. Nonetheless, we see that signature ID 2 is slightly different sizes in all three inclusion targets (5209, 5206, and 5203) with slightly different scores (0.9966, 0.9933, 0.9833). Another slight difference between the signatures is the sequence similarity of signature ID 1 in \textit{inclusion3.fasta} with exclusion sequence:

\begin{minipage}{\linewidth}
\begin{lstlisting}[frame=single, style=bash]
>1 score=0.9792 in=0.9979 ex=0.0187 len=640 ref=inclusion3 pos=3492
CGCGGGCGATATTTTCACAGCCATTTTCAGGAGTTCAGCCATGAACGCTTATTACATTCAGGATCGTCTTGAGGCTCAGA...
\end{lstlisting}
\end{minipage}

This signature had some similarity with exclusion sequence, represented by ex=0.0187, and indicates a small amount of imprecision in this signature. This example illustrates that the \textit{score} (0.9792) is the sum of the \textit{in} (0.9979) and \textit{ex} (0.0187) values.

These differences in signatures from each target are a consequence of sequence differences. The user's discretion will be required in determining which of these are most appropriate. Nonetheless, as described above, Neptune will attempt to consolidate these signatures into a single output file, if only a single answer is desirable.

\end{document}


